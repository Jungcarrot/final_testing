<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page-title">실종 게시물 보기</title>
    <link rel="stylesheet" href="assets/css/postDetail.css">
    <link rel="stylesheet" href="assets/css/postList.css">
    <link rel="stylesheet" href="assets/css/style_main.css">
    <link rel="stylesheet" href="assets/css/postLanguage.css">
    <link rel="stylesheet" href="assets/css/chat.css">
    <script src="assets/js/navigation.js" defer></script>
    <script src="assets/js/login_status.js" defer></script>
    <script src="assets/js/language_index.js" defer></script>
    <script src="assets/js/postList.js" defer></script>
    <script src="assets/js/chat.js" defer></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"></script>
    <script type="module" src="assets/js/DB.js"></script>
</head>
<body>
    <header>
        <!-- 헤더 영역 생략 -->
    </header>
    <main>
        <div class="post-container">
            <h1 id="post-title" data-db-field="title"></h1>
            <div class="post-content">
                <img id="post-image" data-db-field="image" alt="등록된 사진">
                <div id="post-details" data-db-field="details"></div>
            </div>
            <div class="comment-section">
                <h2 data-translate="comment-section-title">댓글</h2>
                <div id="comments" data-db-field="comment">
                    <!-- 댓글 리스트가 동적으로 추가됩니다 -->
                </div>
                <textarea id="comment-input" name="comment" placeholder="댓글을 작성하세요..."></textarea>
                <button id="add-comment" data-translate="add-comment-button">댓글 작성 완료</button>
            </div>
        </div>    
    </main>
    <aside class="right-section">
        <!-- 로그인 상태 UI 영역 생략 -->
    </aside>
    <footer>
        <div class="post-language-selector">
            <button onclick="changeLanguage('ko')" id="lang-ko" class="active">한국어</button>
            <button onclick="changeLanguage('en')" id="lang-en">ENGLISH</button>
        </div>
    </footer>

    <!-- Firebase 연동 관련 스크립트 -->
    <script type="module">
        import { database } from './DB.js';
        import { ref, get, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('id');
            if (!postId) {
                alert('게시물 ID가 존재하지 않습니다.');
                window.location.href = 'lostList.html';
                return;
            }

            // 게시물 데이터 가져오기
            const postRef = ref(database, `Post/${postId}`);
            const snapshot = await get(postRef);

            if (!snapshot.exists()) {
                alert('게시물이 존재하지 않습니다.');
                window.location.href = 'lostList.html';
                return;
            }

            const post = snapshot.val();
            document.getElementById('post-title').textContent = post.title || '제목 없음';
            document.getElementById('post-details').textContent = post.details || '내용이 없습니다.';
            const postImageElement = document.getElementById('post-image');
            if (post.image) {
                postImageElement.src = post.image;
                postImageElement.style.display = 'block';
            } else {
                postImageElement.style.display = 'none';
            }

            // 본인 게시물인지 확인하여 수정/삭제 버튼 표시
            const currentUserId = localStorage.getItem('uid');
            if (currentUserId && post.authorId === currentUserId) {
                document.getElementById('edit-buttons').style.display = 'block';

                document.getElementById('edit-post').addEventListener('click', () => {
                    window.location.href = `lostWrite.html?id=${postId}`;
                });

                document.getElementById('delete-post').addEventListener('click', async () => {
                    const confirmDelete = confirm('정말로 이 게시물을 삭제하시겠습니까?');
                    if (confirmDelete) {
                        await remove(postRef);
                        alert('게시물이 삭제되었습니다.');
                        window.location.href = 'lostList.html';
                    }
                });
            }

            // 댓글 가져오기
            const commentsRef = ref(database, `Comment`);
            onValue(commentsRef, (commentsSnapshot) => {
                const comments = [];
                commentsSnapshot.forEach((childSnapshot) => {
                    const comment = childSnapshot.val();
                    if (comment.postId === postId) {
                        comments.push(comment);
                    }
                });

                const commentContainer = document.getElementById('comments');
                commentContainer.innerHTML = '';
                comments.forEach((commentObj) => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment-item');
                    commentElement.innerHTML = `
                        <strong>${commentObj.nickName}</strong>: ${commentObj.comment}
                    `;
                    commentContainer.appendChild(commentElement);
                });
            });

            // 댓글 작성하기
            document.getElementById('add-comment').addEventListener('click', async () => {
                const commentInput = document.getElementById('comment-input');
                const commentContent = commentInput.value.trim();
                if (!commentContent) {
                    alert('댓글 내용을 입력해주세요.');
                    return;
                }

                if (!currentUserId) {
                    alert('로그인 후 댓글을 작성할 수 있습니다.');
                    return;
                }

                const authorSnapshot = await get(ref(database, `UserData/${currentUserId}`));
                if (!authorSnapshot.exists()) {
                    alert('사용자 정보를 찾을 수 없습니다.');
                    return;
                }

                const nickName = authorSnapshot.val().nickName;

                const newComment = {
                    postId,
                    commenter: currentUserId,
                    nickName,
                    comment: commentContent,
                    time: new Date().toLocaleString()
                };

                try {
                    await push(ref(database, 'Comment'), newComment);
                    commentInput.value = '';
                    alert('댓글이 작성되었습니다.');
                } catch (error) {
                    console.error('댓글 작성 중 오류 발생:', error);
                    alert('댓글 작성 중 오류가 발생했습니다.');
                }
            });
        });
    </script>
</body>
</html>
